<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Isaac — Pocket (Ruffle) UI</title>

<!-- Ruffle Web (unpkg latest) -->
<script src="https://unpkg.com/@ruffle-rs/ruffle@latest/dist/ruffle.js"></script>

<style>
  :root{
    --bg1:#0f1724;
    --bg2:#0b1220;
    --accent:#ff6b35;
    --muted:#9aa7b2;
    --panel: rgba(255,255,255,0.03);
    --glass: rgba(255,255,255,0.04);
    --button-glow: 0 6px 20px rgba(255,107,53,0.16);
  }

  html,body{
    height:100%;
    margin:0;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(180deg,var(--bg1),var(--bg2));
    color: #e6eef4;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }

  .wrapper{
    max-width:980px;
    margin:18px auto;
    padding:18px;
    box-sizing:border-box;
  }

  .card{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:16px;
    padding:14px;
    box-shadow: 0 6px 30px rgba(2,6,23,0.6);
    border: 1px solid rgba(255,255,255,0.04);
  }

  header{
    display:flex;
    gap:12px;
    align-items:center;
    margin-bottom:12px;
  }
  .logo{
    width:48px;
    height:48px;
    background: linear-gradient(135deg,#111827,#0f1724);
    border-radius:10px;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow: var(--button-glow);
    font-weight:700;
    color:var(--accent);
    font-size:20px;
    flex-shrink:0;
  }
  header h1{
    margin:0;
    font-size:18px;
    letter-spacing:0.6px;
  }
  header p{ margin:0; color:var(--muted); font-size:13px; }

  /* Ruffle player area */
  .player-wrap{
    position:relative;
    background:linear-gradient(180deg,#000 0%, #071018 100%);
    border-radius:12px;
    overflow:hidden;
    display:flex;
    justify-content:center;
    align-items:center;
    aspect-ratio: 4 / 3; /* classic game ratio — adjust as desired */
    min-height:320px;
    margin-bottom:14px;
    border:1px solid rgba(255,255,255,0.03);
  }

  ruffle-player{
    width:100%;
    height:100%;
    display:block;
  }

  /* Controls area */
  .controls{
    margin-top:8px;
    display:flex;
    gap:12px;
    align-items:flex-end;
    justify-content:space-between;
  }

  /* Left/right halves */
  .side{
    flex:1;
    display:flex;
    align-items:flex-end;
    justify-content:center;
    padding:8px;
  }

  /* Joystick visual */
  .joystick{
    width:140px;
    height:140px;
    background:var(--panel);
    border-radius:20px;
    position:relative;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow: inset 0 4px 10px rgba(2,6,23,0.6), 0 8px 24px rgba(0,0,0,0.6);
    touch-action:none;
    user-select:none;
  }
  .stick {
    width:64px;
    height:64px;
    border-radius:50%;
    background:linear-gradient(180deg,#22303a,#121a20);
    display:flex;
    align-items:center;
    justify-content:center;
    transform:translate(0,0);
    transition: transform 0.02s linear;
    box-shadow: 0 10px 18px rgba(2,6,23,0.6), 0 4px 12px rgba(0,0,0,0.5);
    color:var(--muted);
    font-weight:700;
    font-size:14px;
    pointer-events:none;
  }
  .joystick .deadzone{
    position:absolute;
    width:56%;
    height:56%;
    border-radius:50%;
    background:transparent;
    border: 1px dashed rgba(255,255,255,0.02);
    pointer-events:none;
  }

  /* Buttons cluster */
  .buttons{
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:center;
    flex-direction:row;
    flex-wrap:wrap;
    width:240px;
  }

  .btn{
    min-width:64px;
    height:64px;
    border-radius:12px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.16));
    border:1px solid rgba(255,255,255,0.03);
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:700;
    font-size:16px;
    color:var(--muted);
    box-shadow: var(--button-glow);
    touch-action: manipulation;
    user-select:none;
  }

  .btn:active, .btn.pressed{
    transform: translateY(2px) scale(0.99);
    box-shadow:none;
    color:white;
    background: linear-gradient(180deg, rgba(255,107,53,0.12), rgba(0,0,0,0.16));
  }

  .btn.big{
    min-width:140px;
    height:72px;
    border-radius:14px;
    font-size:17px;
  }

  /* Bottom hint */
  .hint{
    margin-top:10px;
    color:var(--muted);
    font-size:13px;
    text-align:center;
  }

  /* Responsive tweaks */
  @media (max-width:640px){
    .joystick{ width:120px; height:120px; }
    .stick{ width:56px; height:56px; }
    .buttons{ width:180px; gap:10px; }
    .btn{ min-width:52px; height:52px; border-radius:10px; font-size:15px; }
    .btn.big{ min-width:120px; height:60px;}
    .player-wrap{ min-height:260px; }
  }
</style>
</head>
<body>
  <div class="wrapper">
    <div class="card">
      <header>
        <div class="logo">ISA</div>
        <div>
          <h1>Isaac — Pocket (Ruffle)</h1>
          <p>Top: Flash game (Ruffle). Use joysticks & buttons for mobile controls.</p>
        </div>
      </header>

      <div class="player-wrap" id="player-wrap" aria-label="Isaac game area">
        <!-- The ruffle-player element will load /isaac.swf -->
        <ruffle-player id="ruffle" style="outline:none"></ruffle-player>
      </div>

      <div class="controls" aria-hidden="false">
        <div class="side">
          <div class="joystick" id="left-joy" role="application" aria-label="Movement joystick">
            <div class="deadzone"></div>
            <div class="stick" id="left-stick">WASD</div>
          </div>
        </div>

        <div style="display:flex;flex-direction:column;align-items:center;gap:8px;">
          <div class="buttons" id="buttons">
            <div class="btn" id="btn-q" data-key="q" title="Action (Q)">Q</div>
            <div class="btn" id="btn-e" data-key="e" title="Bomb (E)">E</div>
            <div class="btn big" id="btn-space" data-key=" " title="Ability (Space)">SPACE</div>
          </div>
          <div class="hint">Tip: tap the game once to focus if controls don't work. Works best in Chrome/Edge/Safari mobile.</div>
        </div>

        <div class="side">
          <div class="joystick" id="right-joy" role="application" aria-label="Attack joystick">
            <div class="deadzone"></div>
            <div class="stick" id="right-stick">↦</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/*
  Mobile control mapping to keyboard events.
  Left joystick -> WASD (movement)
  Right joystick -> Arrow keys (attack/aim)
  Buttons -> Q, E, Space
*/

/* ---------- Ruffle init ---------- */
(function initRuffle(){
  // Safe guard: if ruffle is available from the CDN
  if(window.RufflePlayer){
    const ruffle = window.RufflePlayer.newest();
    const player = document.getElementById("ruffle");
    const ruffleInstance = ruffle.createPlayer();
    // Replace placeholder element with configured player
    // The ruffle-player element exists; attach src
    // If using <ruffle-player> (custom element) the library will upgrade it automatically.
    // Setting the src attribute:
    player.style.background = "#000";
    player.setAttribute('src', '/isaac.swf');
    // attempt to make it focusable
    player.setAttribute('tabindex', '0');
    // When the player is clicked/tapped, focus it
    player.addEventListener('pointerdown', ()=> { try { player.focus(); } catch(e){} });
  } else {
    console.warn("RufflePlayer not found. Make sure the CDN loaded.");
  }
})();

/* ---------- Generic keyboard event dispatching ---------- */
// Creates and dispatches keyboard events to window (Ruffle listens to window events).
function dispatchKeyEvent(type, key, code, keyCode) {
  // Some environments use 'which'
  const event = new KeyboardEvent(type, {
    key: key,
    code: code || key,
    keyCode: keyCode || (key ? key.toUpperCase().charCodeAt(0) : 0),
    which: keyCode || (key ? key.toUpperCase().charCodeAt(0) : 0),
    bubbles: true,
    cancelable: true
  });

  // For maximum compatibility, try dispatching to the ruffle player and the window
  const player = document.getElementById('ruffle');
  let dispatched = false;
  try {
    if (player && typeof player.dispatchEvent === 'function') {
      dispatched = player.dispatchEvent(event);
    }
  } catch(e) {}
  // Always also dispatch to window
  try {
    window.dispatchEvent(event);
    dispatched = true;
  } catch(e){}
  return dispatched;
}

/* Key helper */
const KEY = {
  W: {key:'w', code:'KeyW', keyCode:87},
  A: {key:'a', code:'KeyA', keyCode:65},
  S: {key:'s', code:'KeyS', keyCode:83},
  D: {key:'d', code:'KeyD', keyCode:68},
  UP: {key:'ArrowUp', code:'ArrowUp', keyCode:38},
  LEFT: {key:'ArrowLeft', code:'ArrowLeft', keyCode:37},
  DOWN: {key:'ArrowDown', code:'ArrowDown', keyCode:40},
  RIGHT: {key:'ArrowRight', code:'ArrowRight', keyCode:39},
  Q: {key:'q', code:'KeyQ', keyCode:81},
  E: {key:'e', code:'KeyE', keyCode:69},
  SPACE: {key:' ', code:'Space', keyCode:32}
};

/* ---------- Joystick logic ---------- */
function createJoystick(containerEl, stickEl, mappingFn){
  let active = false;
  let identifier = null;
  let startX=0, startY=0;
  let maxRadius = Math.min(containerEl.clientWidth, containerEl.clientHeight)/2;
  let currentDir = {x:0,y:0}; // normalized

  // track which keys are currently pressed so we only send keydown once
  const pressed = new Set();

  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

  function updateStick(x, y){
    const dx = x - startX;
    const dy = y - startY;
    const dist = Math.hypot(dx, dy);
    const angle = Math.atan2(dy, dx);
    const norm = dist / maxRadius;
    // limit distance to 1.0
    const t = clamp(norm, 0, 1);
    const px = Math.cos(angle) * t * (maxRadius - 18);
    const py = Math.sin(angle) * t * (maxRadius - 18);
    stickEl.style.transform = `translate(${px}px, ${py}px)`;
    // compute directional (x,y) normalized -1..1
    const nx = Math.cos(angle) * t;
    const ny = Math.sin(angle) * t;
    currentDir.x = nx;
    currentDir.y = ny;
    // decide which keys to press based on mapping function
    const desired = mappingFn(nx, ny);
    // desired is an array of key objects from KEY
    // release keys not desired
    for(const k of Array.from(pressed)){
      if(!desired.find(d=>d.keyCode===k.keyCode)){
        // send keyup
        dispatchKeyEvent('keyup', k.key, k.code, k.keyCode);
        pressed.delete(k);
      }
    }
    // press desired keys not yet pressed
    for(const k of desired){
      const exists = Array.from(pressed).find(p=>p.keyCode===k.keyCode);
      if(!exists){
        dispatchKeyEvent('keydown', k.key, k.code, k.keyCode);
        pressed.add(k);
      }
    }
  }

  function reset(){
    stickEl.style.transform = `translate(0px, 0px)`;
    // release all pressed
    for(const k of Array.from(pressed)){
      dispatchKeyEvent('keyup', k.key, k.code, k.keyCode);
      pressed.delete(k);
    }
    currentDir = {x:0,y:0};
  }

  function onPointerDown(e){
    // only handle primary pointer
    containerEl.setPointerCapture(e.pointerId);
    active = true;
    identifier = e.pointerId;
    startX = e.clientX;
    startY = e.clientY;
    maxRadius = Math.min(containerEl.clientWidth, containerEl.clientHeight)/2;
  }

  function onPointerMove(e){
    if(!active || e.pointerId !== identifier) return;
    updateStick(e.clientX, e.clientY);
  }

  function onPointerUp(e){
    if(!active || e.pointerId !== identifier) return;
    active = false;
    identifier = null;
    containerEl.releasePointerCapture(e.pointerId);
    reset();
  }

  containerEl.addEventListener('pointerdown', onPointerDown);
  window.addEventListener('pointermove', onPointerMove, {passive:false});
  window.addEventListener('pointerup', onPointerUp);
  window.addEventListener('pointercancel', onPointerUp);

  // In case the user switches orientation/resizes:
  window.addEventListener('resize', ()=> { maxRadius = Math.min(containerEl.clientWidth, containerEl.clientHeight)/2; });

  return { reset };
}

/* Left joystick mapping: WASD based on angle/quadrant */
const leftJoy = document.getElementById('left-joy');
const leftStick = document.getElementById('left-stick');

function leftMapping(nx, ny){
  // ny is -1 up, +1 down (because positive y points down)
  // We'll use a simple 8-direction scheme with thresholds
  const thresh = 0.3;
  const keys = [];
  if (Math.abs(nx) < thresh && Math.abs(ny) < thresh) {
    return keys; // deadzone
  }
  // Up
  if (ny < -thresh) keys.push(KEY.W);
  if (ny > thresh) keys.push(KEY.S);
  if (nx < -thresh) keys.push(KEY.A);
  if (nx > thresh) keys.push(KEY.D);
  return keys;
}

/* Right joystick mapping: Arrow keys */
const rightJoy = document.getElementById('right-joy');
const rightStick = document.getElementById('right-stick');

function rightMapping(nx, ny){
  const thresh = 0.3;
  const keys = [];
  if (Math.abs(nx) < thresh && Math.abs(ny) < thresh) {
    return keys;
  }
  if (ny < -thresh) keys.push(KEY.UP);
  if (ny > thresh) keys.push(KEY.DOWN);
  if (nx < -thresh) keys.push(KEY.LEFT);
  if (nx > thresh) keys.push(KEY.RIGHT);
  return keys;
}

const leftJs = createJoystick(leftJoy, leftStick, leftMapping);
const rightJs = createJoystick(rightJoy, rightStick, rightMapping);

/* ---------- Buttons logic ---------- */
function makeButton(el, keyObj){
  // For mouse and touch / pointer events:
  const pressClass = 'pressed';
  function downHandler(e){
    e.preventDefault();
    el.classList.add(pressClass);
    dispatchKeyEvent('keydown', keyObj.key, keyObj.code, keyObj.keyCode);
  }
  function upHandler(e){
    e.preventDefault();
    el.classList.remove(pressClass);
    dispatchKeyEvent('keyup', keyObj.key, keyObj.code, keyObj.keyCode);
  }
  el.addEventListener('pointerdown', downHandler);
  window.addEventListener('pointerup', upHandler);
  // Also support pointercancel/out
  el.addEventListener('pointercancel', upHandler);
  el.addEventListener('pointerout', upHandler);
  el.addEventListener('lostpointercapture', upHandler);

  // For accessibility: keyboard control
  el.setAttribute('tabindex','0');
  el.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' || e.key===' '){
      downHandler(e);
    }
  });
  el.addEventListener('keyup', (e)=>{
    if(e.key==='Enter' || e.key===' '){
      upHandler(e);
    }
  });
}

makeButton(document.getElementById('btn-q'), KEY.Q);
makeButton(document.getElementById('btn-e'), KEY.E);
makeButton(document.getElementById('btn-space'), KEY.SPACE);

/* ---------- Focus helper ---------- */
(function focusHint(){
  const player = document.getElementById('ruffle');
  // attempt to focus the player for keyboard events (some browsers require user gesture)
  const maybeFocus = ()=>{
    try { player.focus(); } catch(e){}
  };
  // Try on load and on first user interaction
  window.addEventListener('load', maybeFocus);
  window.addEventListener('pointerdown', maybeFocus, {once:true});
})();

/* ---------- Extra: make sure when page hidden we release keys ---------- */
document.addEventListener('visibilitychange', ()=>{
  if(document.hidden){
    // send keyup for common keys to make sure nothing gets stuck
    const all = [KEY.W,KEY.A,KEY.S,KEY.D,KEY.UP,KEY.DOWN,KEY.LEFT,KEY.RIGHT,KEY.Q,KEY.E,KEY.SPACE];
    for(const k of all) dispatchKeyEvent('keyup', k.key, k.code, k.keyCode);
  }
});

/* ---------- Notes for users (console) ---------- */
console.log("Mobile controls loaded: left joystick = WASD, right joystick = arrows, Q/E/SPACE buttons.");
console.log("If controls don't work, tap the game area once to focus the Ruffle player.");
</script>
</body>
</html>
