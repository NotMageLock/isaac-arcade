<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Isaac Arcade</title>
<style>
html, body {
  margin:0; height:100%; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background: center / cover no-repeat url('background.jpg'); -webkit-user-select:none; -ms-user-select:none; user-select:none; overflow:hidden;
}
body {
  display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
}
#ruffle-container {
  width:100%; max-width:900px; aspect-ratio:4/3; position:relative; margin-top:12px;
}
#ruffle-player {
  width:100%; height:100%; position:absolute; inset:0;
}
.controls {
  width:100%; max-width:900px; display:flex; justify-content:space-between; align-items:center; margin-top:auto; padding:12px; box-sizing:border-box; pointer-events:none;
}
.stick {
  width:40%; aspect-ratio:1/1; background: rgba(255,255,255,0.06); border-radius:50%; position:relative; touch-action:none; display:grid; place-items:center; pointer-events:auto;
}
.thumb {
  width:40%; height:40%; background:rgba(255,255,255,0.4); border-radius:50%; position:absolute; left:30%; top:30%; transition:left 0.05s, top 0.05s;
}
.mid-buttons {
  display:flex; flex-direction:column; gap:8px; justify-content:center; align-items:center; pointer-events:auto;
}
.mid-buttons button {
  min-width:70px; padding:12px; font-weight:700; font-size:16px; border:none; border-radius:8px; background:rgba(0,0,0,0.7); color:#fff;
}
@media(max-width:420px){
  .stick { width:46%; } .mid-buttons button { min-width:56px; padding:10px; font-size:14px; }
}
</style>
</head>
<body>

<div id="ruffle-container"></div>

<div class="controls">
  <div class="stick" id="left-stick"><div class="thumb" id="left-thumb"></div></div>

  <div class="mid-buttons">
    <button data-key="KeyQ">Q</button>
    <button data-key="KeyE">E</button>
    <button data-key="Space">Space</button>
  </div>

  <div class="stick" id="right-stick"><div class="thumb" id="right-thumb"></div></div>
</div>

<script src="https://unpkg.com/@ruffle-rs/ruffle"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const SWF_URL = 'https://files.catbox.moe/kk84m9.swf';
  const ruffleContainer = document.getElementById('ruffle-container');
  const ruffle = window.RufflePlayer.newest();
  const player = ruffle.createPlayer();
  player.id = 'ruffle-player';
  ruffleContainer.appendChild(player);
  player.load(SWF_URL);

  function focusPlayer() { try { player.focus(); } catch(e){} }
  ruffleContainer.addEventListener('mousedown', focusPlayer);
  ruffleContainer.addEventListener('touchstart', focusPlayer, {passive:false});

  function dispatchKey(type, code){
    focusPlayer();
    const ev = new KeyboardEvent(type, {bubbles:true, cancelable:true, composed:true, key: code==='Space'?' ':code, code});
    try { player.dispatchEvent(ev); } catch(e){}
  }

  document.querySelectorAll('.mid-buttons button').forEach(btn=>{
    const code = btn.getAttribute('data-key');
    let active=false;
    const start = e=>{ e.preventDefault(); if(active) return; active=true; btn.classList.add('active'); dispatchKey('keydown', code); }
    const end = e=>{ e.preventDefault(); if(!active) return; active=false; btn.classList.remove('active'); dispatchKey('keyup', code); }
    btn.addEventListener('mousedown', start);
    btn.addEventListener('touchstart', start, {passive:false});
    btn.addEventListener('mouseup', end);
    btn.addEventListener('mouseleave', end);
    btn.addEventListener('touchend', end, {passive:false});
    btn.addEventListener('touchcancel', end, {passive:false});
  });

  function setupJoystick(stickEl, thumbEl, keyMap){
    let activeKeys = new Set();

    const rect = stickEl.getBoundingClientRect();
    const centerX = rect.left + rect.width/2;
    const centerY = rect.top + rect.height/2;
    const maxMove = rect.width/2 - thumbEl.offsetWidth/2;

    function start(e){
      e.preventDefault(); focusPlayer();
      const moveHandler = ev=>{
        ev.preventDefault();
        const pos = ev.touches ? ev.touches[0] : ev;
        const dx = pos.clientX - centerX;
        const dy = pos.clientY - centerY;
        const threshold = 10;

        let newKeys = new Set();
        if(dy < -threshold) newKeys.add(keyMap.up);
        if(dy > threshold) newKeys.add(keyMap.down);
        if(dx < -threshold) newKeys.add(keyMap.left);
        if(dx > threshold) newKeys.add(keyMap.right);

        activeKeys.forEach(k=>{ if(!newKeys.has(k)) dispatchKey('keyup', k); });
        newKeys.forEach(k=>{ if(!activeKeys.has(k)) dispatchKey('keydown', k); });
        activeKeys = newKeys;

        let moveX = Math.max(-maxMove, Math.min(maxMove, dx));
        let moveY = Math.max(-maxMove, Math.min(maxMove, dy));
        thumbEl.style.left = 50 + moveX/maxMove*50 - 20 + '%';
        thumbEl.style.top = 50 + moveY/maxMove*50 - 20 + '%';
      };

      const endHandler = ev=>{
        ev.preventDefault();
        activeKeys.forEach(k=>dispatchKey('keyup', k));
        activeKeys.clear();
        thumbEl.style.left='30%'; thumbEl.style.top='30%';
        document.removeEventListener('mousemove', moveHandler);
        document.removeEventListener('mouseup', endHandler);
        document.removeEventListener('touchmove', moveHandler);
        document.removeEventListener('touchend', endHandler);
        document.removeEventListener('touchcancel', endHandler);
      };

      document.addEventListener('mousemove', moveHandler);
      document.addEventListener('mouseup', endHandler);
      document.addEventListener('touchmove', moveHandler, {passive:false});
      document.addEventListener('touchend', endHandler, {passive:false});
      document.addEventListener('touchcancel', endHandler, {passive:false});
    }

    stickEl.addEventListener('mousedown', start);
    stickEl.addEventListener('touchstart', start, {passive:false});
  }

  setupJoystick(document.getElementById('left-stick'), document.getElementById('left-thumb'), {up:'KeyW', down:'KeyS', left:'KeyA', right:'KeyD'});
  setupJoystick(document.getElementById('right-stick'), document.getElementById('right-thumb'), {up:'ArrowUp', down:'ArrowDown', left:'ArrowLeft', right:'ArrowRight'});
});
</script>
</body>
</html>
