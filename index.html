<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1" />
  <title>Isaac Arcade</title>
  <style>
    html,body{height:100%;margin:0}
    body{
      background: center / cover no-repeat url('bg.jpeg');
      -webkit-touch-callout: none; -webkit-user-select: none; -ms-user-select: none; user-select: none;
      display:flex; flex-direction:column; align-items:center; justify-content:flex-start; gap:12px; padding:12px; box-sizing:border-box;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    .game-wrap{ width:100%; max-width:900px; position:relative; }
    .game-outer{ width:100%; padding-top:75%; position:relative; background:transparent; border-radius:8px; overflow:hidden; box-shadow: 0 6px 18px rgba(0,0,0,0.35);}
    #game-container{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:transparent }

    .run-overlay{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; z-index:5 }
    .run-btn{ background:rgba(0,0,0,0.7); color:#fff; border:none; padding:14px 20px; font-size:18px; border-radius:8px; cursor:pointer }

    .controls{ width:100%; max-width:900px; display:flex; gap:12px; justify-content:space-between; align-items:center; box-sizing:border-box }
    .stick{ width:40%; max-width:320px; aspect-ratio:1/1; background:rgba(255,255,255,0.06); border-radius:12px; display:grid; place-items:center; padding:6px }
    .dpad{ width:100%; height:100%; display:grid; grid-template-columns:repeat(3,1fr); grid-template-rows:repeat(3,1fr); gap:6px }
    .dpad button{ width:100%; height:100%; border-radius:8px; border:0; font-weight:700; font-size:16px; touch-action:none }
    .dpad .center{ background:transparent; pointer-events:none }

    .mid-buttons{ display:flex; gap:8px; align-items:center; justify-content:center }
    .mid-buttons button{ padding:12px 14px; font-weight:700; border-radius:8px; border:0; min-width:56px; height:48px; font-size:16px }
    .space-btn{ min-width:110px }

    @media (max-width:420px){ .stick{ width:46% } .mid-buttons button{ padding:10px 12px; height:44px } }
  </style>
</head>
<body>
  <div class="game-wrap">
    <div class="game-outer">
      <div id="game-container">
        <!-- Ruffle player will be inserted here when Run Game is pressed -->
      </div>
      <div class="run-overlay" id="run-overlay">
        <button id="run-btn" class="run-btn">Run Game</button>
      </div>
    </div>
  </div>

  <div class="controls">
    <!-- Left joystick: WASD -->
    <div class="stick" id="left-stick" aria-hidden="false">
      <div class="dpad">
        <button data-key="KeyQ" class="center" style="visibility:hidden"></button>
        <button data-key="KeyW">W</button>
        <button data-key="KeyE" style="visibility:hidden"></button>

        <button data-key="KeyA">A</button>
        <div class="center"></div>
        <button data-key="KeyD">D</button>

        <button data-key="KeyZ" style="visibility:hidden"></button>
        <button data-key="KeyS">S</button>
        <button data-key="KeyC" style="visibility:hidden"></button>
      </div>
    </div>

    <!-- Middle action buttons: Q, E, Space -->
    <div class="mid-buttons">
      <button data-key="KeyQ">Q</button>
      <button data-key="KeyE">E</button>
      <button data-key="Space" class="space-btn">Space</button>
    </div>

    <!-- Right joystick: Arrow keys -->
    <div class="stick" id="right-stick" aria-hidden="false">
      <div class="dpad">
        <button data-key="ArrowUp" style="visibility:visible">↑</button>
        <button data-key="" class="center" style="visibility:hidden"></button>
        <button data-key="" style="visibility:hidden"></button>

        <button data-key="ArrowLeft">←</button>
        <div class="center"></div>
        <button data-key="ArrowRight">→</button>

        <button data-key="" style="visibility:hidden"></button>
        <button data-key="ArrowDown">↓</button>
        <button data-key="" style="visibility:hidden"></button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/@ruffle-rs/ruffle@latest/dist/ruffle.js"></script>
  <script>
    const SWF_URL = 'https://github.com/NotMageLock/isaac-arcade/releases/download/large-files/isaac.swf';

    const runBtn = document.getElementById('run-btn');
    const runOverlay = document.getElementById('run-overlay');
    const gameContainer = document.getElementById('game-container');

    let rufflePlayer = null;

    function createRufflePlayer(){
      if (!window.RufflePlayer || !window.RufflePlayer.newest) {
        alert('Ruffle failed to load — please check your connection or reload the page.');
        return;
      }
      const ruffle = window.RufflePlayer.newest();

      const player = ruffle.createPlayer();
      player.style.width = '100%';
      player.style.height = '100%';
      player.tabIndex = 0;
      player.load(SWF_URL);
      return player;
    }

    runBtn.addEventListener('click', ()=>{
      if (!rufflePlayer){
        rufflePlayer = createRufflePlayer();
        gameContainer.appendChild(rufflePlayer);
      }
      runOverlay.style.display = 'none';
      setTimeout(()=>{
        try{ rufflePlayer.focus(); }catch(e){}
      },100);
    });

    function dispatchKeyEvent(type, code){
      if (!code) return;
      const eventInit = { bubbles:true, cancelable:true, composed:true, key: code === 'Space' ? ' ' : '', code: code };
      const ev = new KeyboardEvent(type, eventInit);
      window.dispatchEvent(ev);
      try{ if (rufflePlayer && rufflePlayer.contentWindow) rufflePlayer.contentWindow.dispatchEvent(ev); }catch(e){}
    }

    function setupButtons(){
      const btns = document.querySelectorAll('[data-key]');
      btns.forEach(btn=>{
        const code = btn.getAttribute('data-key');
        let active = false;
        btn.addEventListener('touchstart', e=>{ e.preventDefault(); if(active) return; active=true; btn.classList.add('active'); dispatchKeyEvent('keydown', code); });
        btn.addEventListener('touchend', e=>{ e.preventDefault(); if(!active) return; active=false; btn.classList.remove('active'); dispatchKeyEvent('keyup', code); });
        btn.addEventListener('touchcancel', e=>{ e.preventDefault(); if(!active) return; active=false; btn.classList.remove('active'); dispatchKeyEvent('keyup', code); });
        btn.addEventListener('mousedown', e=>{ e.preventDefault(); if(active) return; active=true; btn.classList.add('active'); dispatchKeyEvent('keydown', code); });
        window.addEventListener('mouseup', e=>{ if(!active) return; active=false; btn.classList.remove('active'); dispatchKeyEvent('keyup', code); });
      });
    }

    setupButtons();

    document.addEventListener('gesturestart', e=>e.preventDefault());

  </script>
</body>
</html>
