<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Isaac Arcade</title>
<style>
html, body {
  margin:0; height:100%;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background:center / cover no-repeat url('background.jpg');
  -webkit-user-select:none; -ms-user-select:none; user-select:none;
  overflow:hidden;
}
body { display:flex; flex-direction:column; align-items:center; justify-content:flex-start; }
#ruffle-container {
  width:100%; max-width:900px; aspect-ratio:4/3;
  position:relative; margin-top:12px;
}
#ruffle-player {
  width:100%; height:100%; position:absolute; inset:0;
}
.controls {
  width:100%; max-width:900px; display:flex; justify-content:space-between; align-items:center;
  margin-top:auto; padding:12px; box-sizing:border-box; pointer-events:none;
}
.stick {
  width:40%; aspect-ratio:1/1; background: rgba(255,255,255,0.06); border-radius:50%;
  position:relative; touch-action:none; display:grid; place-items:center; pointer-events:auto;
}
.thumb {
  width:40%; height:40%; background:rgba(255,255,255,0.4); border-radius:50%;
  position:absolute; left:30%; top:30%; transition:left 0.05s, top 0.05s;
}
.mid-buttons {
  display:flex; flex-direction:column; gap:8px; justify-content:center; align-items:center; pointer-events:auto;
}
.mid-buttons button {
  min-width:70px; padding:12px; font-weight:700; font-size:16px;
  border:none; border-radius:8px;
  background:rgba(0,0,0,0.7); color:#fff;
}
@media(max-width:420px){
  .stick { width:46%; }
  .mid-buttons button { min-width:56px; padding:10px; font-size:14px; }
}
</style>
</head>
<body>

<div id="ruffle-container"></div>

<div class="controls">
  <div class="stick" id="left-stick"><div class="thumb" id="left-thumb"></div></div>
  <div class="mid-buttons">
    <button data-key="KeyQ">Q</button>
    <button data-key="KeyE">E</button>
    <button data-key="Space">Space</button>
  </div>
  <div class="stick" id="right-stick"><div class="thumb" id="right-thumb"></div></div>
</div>

<script src="https://unpkg.com/@ruffle-rs/ruffle"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const SWF_URL = 'https://files.catbox.moe/kk84m9.swf';
  const ruffleContainer = document.getElementById('ruffle-container');
  const ruffle = window.RufflePlayer.newest();
  const player = ruffle.createPlayer();
  player.id = 'ruffle-player';
  ruffleContainer.appendChild(player);

  // Load the SWF and focus
  player.load(SWF_URL).then(() => {
    tryFocus();
  });

  // --- focus handling ---
  function tryFocus() {
    try { player.focus(); } catch(e){}
    if (!player.input) {
      setTimeout(tryFocus, 300); // retry until player.input is ready
    }
  }

  // Prevent scroll on arrow keys or space
  window.addEventListener('keydown', e => {
    if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(e.key)) {
      e.preventDefault();
    }
  }, { passive:false });

  // Focus on first user interaction (for mobile)
  document.body.addEventListener('touchstart', () => tryFocus(), { once:true, passive:false });
  document.body.addEventListener('mousedown', () => tryFocus(), { once:true });

  // --- safe key dispatcher ---
  function dispatchKey(type, code) {
    if (!player.input) { // fallback retry if input isn't ready yet
      setTimeout(() => dispatchKey(type, code), 150);
      return;
    }
    if (type === 'keydown') player.input.keyDown(code);
    else if (type === 'keyup') player.input.keyUp(code);
  }

  // --- Button controls ---
  document.querySelectorAll('.mid-buttons button').forEach(btn => {
    const code = btn.getAttribute('data-key');
    let active = false;

    const start = e => {
      e.preventDefault();
      if (active) return;
      active = true;
      btn.classList.add('active');
      dispatchKey('keydown', code);
    };
    const end = e => {
      e.preventDefault();
      if (!active) return;
      active = false;
      btn.classList.remove('active');
      dispatchKey('keyup', code);
    };

    btn.addEventListener('mousedown', start);
    btn.addEventListener('touchstart', start, { passive:false });
    btn.addEventListener('mouseup', end);
    btn.addEventListener('mouseleave', end);
    btn.addEventListener('touchend', end, { passive:false });
    btn.addEventListener('touchcancel', end, { passive:false });
  });

  // --- Joystick controls ---
  function setupJoystick(stickEl, thumbEl, keyMap) {
    let activeKeys = new Set();

    function getCenter() {
      const rect = stickEl.getBoundingClientRect();
      return {
        cx: rect.left + rect.width/2,
        cy: rect.top + rect.height/2,
        maxMove: rect.width/2 - thumbEl.offsetWidth/2
      };
    }

    function start(e) {
      e.preventDefault();
      tryFocus();
      const center = getCenter();

      function moveHandler(ev) {
        ev.preventDefault();
        const pos = ev.touches ? ev.touches[0] : ev;
        let dx = pos.clientX - center.cx;
        let dy = pos.clientY - center.cy;

        const distance = Math.sqrt(dx*dx + dy*dy);
        const maxDist = center.maxMove;
        if (distance > maxDist) {
          const ratio = maxDist / distance;
          dx *= ratio; dy *= ratio;
        }

        const threshold = 5;
        let newKeys = new Set();
        if (dy < -threshold) newKeys.add(keyMap.up);
        if (dy > threshold) newKeys.add(keyMap.down);
        if (dx < -threshold) newKeys.add(keyMap.left);
        if (dx > threshold) newKeys.add(keyMap.right);

        activeKeys.forEach(k => { if (!newKeys.has(k)) dispatchKey('keyup', k); });
        newKeys.forEach(k => { if (!activeKeys.has(k)) dispatchKey('keydown', k); });
        activeKeys = newKeys;

        thumbEl.style.left = 50 + dx/maxDist*50 - 20 + '%';
        thumbEl.style.top  = 50 + dy/maxDist*50 - 20 + '%';
      }

      function endHandler(ev) {
        ev.preventDefault();
        activeKeys.forEach(k => dispatchKey('keyup', k));
        activeKeys.clear();
        thumbEl.style.left = '30%';
        thumbEl.style.top = '30%';
        document.removeEventListener('mousemove', moveHandler);
        document.removeEventListener('mouseup', endHandler);
        document.removeEventListener('touchmove', moveHandler);
        document.removeEventListener('touchend', endHandler);
        document.removeEventListener('touchcancel', endHandler);
      }

      document.addEventListener('mousemove', moveHandler);
      document.addEventListener('mouseup', endHandler);
      document.addEventListener('touchmove', moveHandler, { passive:false });
      document.addEventListener('touchend', endHandler, { passive:false });
      document.addEventListener('touchcancel', endHandler, { passive:false });
    }

    stickEl.addEventListener('mousedown', start);
    stickEl.addEventListener('touchstart', start, { passive:false });
  }

  setupJoystick(document.getElementById('left-stick'), document.getElementById('left-thumb'), {
    up:'KeyW', down:'KeyS', left:'KeyA', right:'KeyD'
  });
  setupJoystick(document.getElementById('right-stick'), document.getElementById('right-thumb'), {
    up:'ArrowUp', down:'ArrowDown', left:'ArrowLeft', right:'ArrowRight'
  });
});
</script>
</body>
</html>
