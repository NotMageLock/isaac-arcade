<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
<title>Isaac — Pocket GameBoy</title>

<!-- Ruffle Web -->
<script src="https://unpkg.com/@ruffle-rs/ruffle@latest/dist/ruffle.js"></script>

<style>
  :root{
    --bg:#e9f0f5;
    --shell:#ccd6dd;
    --glass:#0b1220;
    --accent:#2b2b2b;
    --accent-2:#ff6b35;
    --panel: rgba(0,0,0,0.08);
    --muted:#6b7780;
  }

  /* Basic page reset + prevent zooming / overscroll */
  html,body{
    height:100%;
    margin:0;
    -webkit-user-select:none;
    -ms-user-select:none;
    user-select:none;
    -webkit-touch-callout:none;
    -webkit-tap-highlight-color: transparent;
    overscroll-behavior: none;
    background: #0b0f12;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    color: #fff;
  }
  /* background wrapper with rotated image */
  .bg-wrap{
    position:fixed;
    inset:0;
    overflow:hidden;
    z-index:-2;
    pointer-events:none;
  }
  .bg-image{
    position:absolute;
    left:50%;
    top:50%;
    width:140vmax; /* big so rotation still covers */
    height:auto;
    transform-origin:center center;
    transform: translate(-50%,-50%) rotate(40deg) scale(1);
    will-change:transform;
    filter: contrast(0.95) saturate(0.95) brightness(0.85);
    opacity:0.95;
  }

  /* Page shell / center */
  .app{
    min-height:100vh;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-start;
    padding:12px;
    box-sizing:border-box;
  }

  /* GameBoy shell */
  .gb-shell{
    width: min(920px, 96vw);
    height: 100vh;
    max-height: 1100px;
    display:flex;
    flex-direction:column;
    background: linear-gradient(180deg, var(--shell), #d7dde2);
    border-radius:18px;
    padding:18px;
    box-sizing:border-box;
    box-shadow: 0 10px 40px rgba(0,0,0,0.6);
    border: 10px solid #bfc8cf;
    position:relative;
  }

  /* top area: header + speaker grills */
  .top-row{
    display:flex;
    align-items:center;
    gap:12px;
    margin-bottom:8px;
  }
  .gb-logo{
    width:84px;
    height:40px;
    background: linear-gradient(180deg,#f7f9fb,#e6ebef);
    border-radius:8px;
    display:flex;
    align-items:center;
    justify-content:center;
    color:var(--accent);
    font-weight:800;
    letter-spacing:0.6px;
    box-shadow: inset 0 -4px 8px rgba(0,0,0,0.06);
  }
  .gb-info{
    display:flex;
    flex-direction:column;
    justify-content:center;
  }
  .gb-info .title{ color:#2b2b2b; font-weight:700; font-size:16px; }
  .gb-info .sub{ color:var(--muted); font-size:12px; margin-top:2px; }

  /* The isaac window area: should take top half of the screen */
  .display-wrap{
    flex: 0 0 50vh; /* force top half of viewport height */
    max-height:50vh;
    min-height:260px;
    margin:8px 4px 12px 4px;
    display:flex;
    justify-content:center;
    align-items:center;
  }
  .display-frame{
    width:100%;
    height:100%;
    background:var(--glass);
    border-radius:8px;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow: inset 0 6px 18px rgba(0,0,0,0.6);
    border: 6px solid #000; /* black border */
    position:relative;
    overflow:hidden;
  }
  /* ruffle player should fit and scale to container (no zoom) */
  ruffle-player{
    width:100%;
    height:100%;
    display:block;
    object-fit:contain;
    background:#000;
  }

  /* Controls area - bottom half-ish */
  .controls-wrap{
    margin-top:6px;
    display:flex;
    flex-direction:column;
    gap:12px;
    align-items:stretch;
    justify-content:flex-end;
    flex:1 1 auto;
  }

  .controls{
    display:flex;
    gap:12px;
    align-items:flex-end;
    justify-content:space-between;
    padding:12px;
  }

  .side{ flex:1; display:flex; align-items:flex-end; justify-content:center; }
  .joystick{
    width:140px;
    height:140px;
    border-radius:18px;
    background: linear-gradient(180deg, rgba(0,0,0,0.06), rgba(255,255,255,0.02));
    box-shadow: 0 8px 24px rgba(0,0,0,0.35);
    position:relative;
    display:flex;
    align-items:center;
    justify-content:center;
    touch-action:none;
    user-select:none;
  }
  .deadzone{
    position:absolute;
    width:56%;
    height:56%;
    border-radius:50%;
    border: 1px dashed rgba(0,0,0,0.06);
    pointer-events:none;
  }
  .stick{
    width:62px;
    height:62px;
    border-radius:50%;
    background: linear-gradient(180deg,#2b2b2b,#111);
    display:flex;
    align-items:center;
    justify-content:center;
    color:#f0f0f0;
    font-weight:800;
    pointer-events:none;
    transform: translate(0,0);
    transition: transform 0.02s linear;
  }

  /* center button cluster (Q/E/Space) */
  .center-controls{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:8px;
    width:260px;
  }
  .buttons{
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:center;
    flex-wrap:wrap;
  }
  .btn{
    min-width:60px;
    height:60px;
    border-radius:12px;
    background: linear-gradient(180deg,#f0f2f4,#dfe6ea);
    color:#1a1a1a;
    font-weight:800;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow: 0 8px 20px rgba(0,0,0,0.25);
    touch-action:manipulation;
    user-select:none;
  }
  .btn:active, .btn.pressed{
    transform: translateY(2px) scale(0.99);
    box-shadow:none;
    background: linear-gradient(180deg,#cfcfcf,#bdbdbd);
  }
  .btn.big{
    min-width:140px;
    height:68px;
    border-radius:14px;
  }

  /* Gameboy visual details */
  .gb-controls-row{
    display:flex;
    gap:18px;
    align-items:center;
    justify-content:space-between;
    margin-top:6px;
  }
  .dpad-label, .action-label{ font-size:12px; color:var(--muted); text-align:center; }

  /* Bottom hints */
  .footer-hint{
    text-align:center;
    font-size:12px;
    color:var(--muted);
    margin-top:8px;
  }

  /* Responsive tweaks */
  @media (max-width:640px){
    .joystick{ width:120px; height:120px; }
    .stick{ width:52px; height:52px; }
    .center-controls{ width:200px; }
    .btn{ min-width:52px; height:52px; font-size:14px; }
    .btn.big{ min-width:110px; height:60px; }
    .display-wrap{ flex-basis:50vh; max-height:50vh; min-height:220px; }
    .gb-shell{ padding:12px; border-width:8px; border-radius:14px; }
  }

  /* Hide scrollbars */
  ::-webkit-scrollbar { width:0; height:0; }
</style>
</head>
<body>
  <div class="bg-wrap" aria-hidden="true">
    <img src="IMG_7474.jpeg" alt="" class="bg-image" />
  </div>

  <div class="app">
    <div class="gb-shell" role="application" aria-label="Pocket Isaac">
      <div class="top-row">
        <div class="gb-logo">GAME</div>
        <div class="gb-info">
          <div class="title">The Binding of Isaac — Pocket</div>
          <div class="sub">Play with touch controls — designed to feel like a Game Boy</div>
        </div>
      </div>

      <div class="display-wrap">
        <div class="display-frame" id="display-frame" aria-label="Isaac game window">
          <!-- Ruffle player -->
          <ruffle-player id="ruffle" tabindex="0" aria-hidden="false"></ruffle-player>
        </div>
      </div>

      <div class="controls-wrap">
        <div class="controls">
          <div class="side">
            <div class="joystick" id="left-joy" role="application" aria-label="Movement joystick">
              <div class="deadzone"></div>
              <div class="stick" id="left-stick">WASD</div>
            </div>
          </div>

          <div class="center-controls">
            <div class="buttons" id="buttons">
              <div class="btn" id="btn-q" data-key="q" title="Action (Q)">Q</div>
              <div class="btn" id="btn-e" data-key="e" title="Bomb (E)">E</div>
              <div class="btn big" id="btn-space" data-key=" " title="Ability (Space)">SPACE</div>
            </div>
            <div class="gb-controls-row" style="width:100%;">
              <div class="dpad-label">Move</div>
              <div class="action-label">Aim / Attack</div>
            </div>
          </div>

          <div class="side">
            <div class="joystick" id="right-joy" role="application" aria-label="Attack joystick">
              <div class="deadzone"></div>
              <div class="stick" id="right-stick">↦</div>
            </div>
          </div>
        </div>

        <div class="footer-hint">Tip: If controls don't respond, tap the screen once to focus the game. Best on Chrome/Edge/Safari mobile.</div>
      </div>
    </div>
  </div>

<script>
/* ---------------- Ruffle init & auto-start ---------------- */
(function initRuffle() {
  const SWF_URL = "https://github.com/NotMageLock/isaac-arcade/releases/download/large-files/isaac.swf";

  // If Ruffle is present as a Web component, set src attribute
  const playerEl = document.getElementById('ruffle');
  if (window.RufflePlayer && playerEl) {
    try {
      playerEl.setAttribute('src', SWF_URL);
      playerEl.style.background = "#000";
      playerEl.setAttribute('tabindex','0');
    } catch (e) {
      console.warn("Failed to set ruffle src:", e);
    }
  } else {
    console.warn("RufflePlayer not found — check CDN.");
  }

  // Try to automatically "start" / focus the SWF on load.
  // Note: many browsers require user gesture; we focus on first pointerdown if needed.
  function tryAutoStart() {
    try {
      playerEl.focus && playerEl.focus();
      // Some Ruffle builds respond if we dispatch a synthetic click/pointerdown to the player.
      const ev = new PointerEvent('pointerdown', {bubbles:true, cancelable:true});
      playerEl.dispatchEvent(ev);
    } catch (e) {}
  }

  window.addEventListener('load', tryAutoStart);
  // Also attempt on first user interaction (this will satisfy browsers that require gesture)
  window.addEventListener('pointerdown', function onFirst() {
    tryAutoStart();
    window.removeEventListener('pointerdown', onFirst);
  }, {passive:true});
})();

/* ---------------- Prevent pinch-zoom & double-tap zoom on iOS/Android where possible ---------------- */
(function preventZoomHints(){
  // Already set viewport to maximum-scale=1,user-scalable=no. Add touch-action and event listeners to prevent double-tap
  let lastTouch = 0;
  window.addEventListener('touchstart', function(e){
    const now = Date.now();
    if (now - lastTouch <= 300) e.preventDefault(); // prevent double-tap-to-zoom
    lastTouch = now;
  }, {passive:false});
})();

/* ---------------- Keyboard dispatch helper ---------------- */
function dispatchKeyEvent(type, key, code, keyCode) {
  // Create KeyboardEvent with common fields
  let event;
  try {
    event = new KeyboardEvent(type, {
      key: key,
      code: code || key,
      keyCode: keyCode || (key ? key.toUpperCase().charCodeAt(0) : 0),
      which: keyCode || (key ? key.toUpperCase().charCodeAt(0) : 0),
      bubbles: true,
      cancelable: true
    });
  } catch (e) {
    // Fallback for older mobile browsers
    event = document.createEvent('KeyboardEvent');
    try {
      event.initKeyboardEvent(type, true, true, window, key, 0, "", false, "");
    } catch (err) {
      // last-resort simple event
      event = document.createEvent('Event');
      event.initEvent(type, true, true);
    }
  }

  // Try dispatch to ruffle element and window
  const player = document.getElementById('ruffle');
  try { player && player.dispatchEvent && player.dispatchEvent(event); } catch(e){}
  try { window.dispatchEvent(event); } catch(e){}
}

/* Key map */
const KEY = {
  W: {key:'w', code:'KeyW', keyCode:87},
  A: {key:'a', code:'KeyA', keyCode:65},
  S: {key:'s', code:'KeyS', keyCode:83},
  D: {key:'d', code:'KeyD', keyCode:68},
  UP: {key:'ArrowUp', code:'ArrowUp', keyCode:38},
  LEFT: {key:'ArrowLeft', code:'ArrowLeft', keyCode:37},
  DOWN: {key:'ArrowDown', code:'ArrowDown', keyCode:40},
  RIGHT: {key:'ArrowRight', code:'ArrowRight', keyCode:39},
  Q: {key:'q', code:'KeyQ', keyCode:81},
  E: {key:'e', code:'KeyE', keyCode:69},
  SPACE: {key:' ', code:'Space', keyCode:32}
};

/* ---------------- Joystick creation (left/right) ---------------- */
function createJoystick(containerEl, stickEl, mappingFn){
  let active = false;
  let id = null;
  let startX = 0, startY = 0;
  let maxRadius = Math.min(containerEl.clientWidth, containerEl.clientHeight)/2;
  const pressed = new Set();

  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

  function updateStick(cx, cy){
    const dx = cx - startX;
    const dy = cy - startY;
    const dist = Math.hypot(dx, dy);
    const angle = Math.atan2(dy, dx);
    const norm = dist / maxRadius;
    const t = clamp(norm, 0, 1);
    const px = Math.cos(angle) * t * (maxRadius - 18);
    const py = Math.sin(angle) * t * (maxRadius - 18);
    stickEl.style.transform = `translate(${px}px, ${py}px)`;
    const nx = Math.cos(angle) * t;
    const ny = Math.sin(angle) * t;
    const desired = mappingFn(nx, ny);

    // release keys that are no longer desired
    for(const k of Array.from(pressed)){
      if(!desired.find(d => d.keyCode === k.keyCode)){
        dispatchKeyEvent('keyup', k.key, k.code, k.keyCode);
        pressed.delete(k);
      }
    }
    // press desired keys not yet pressed
    for(const k of desired){
      const exists = Array.from(pressed).find(p => p.keyCode === k.keyCode);
      if(!exists){
        dispatchKeyEvent('keydown', k.key, k.code, k.keyCode);
        pressed.add(k);
      }
    }
  }

  function reset(){
    stickEl.style.transform = `translate(0,0)`;
    for(const k of Array.from(pressed)){
      dispatchKeyEvent('keyup', k.key, k.code, k.keyCode);
      pressed.delete(k);
    }
  }

  function onDown(e){
    e.preventDefault();
    containerEl.setPointerCapture && containerEl.setPointerCapture(e.pointerId);
    active = true;
    id = e.pointerId;
    startX = e.clientX;
    startY = e.clientY;
    maxRadius = Math.min(containerEl.clientWidth, containerEl.clientHeight)/2;
  }

  function onMove(e){
    if(!active || e.pointerId !== id) return;
    e.preventDefault();
    updateStick(e.clientX, e.clientY);
  }

  function onUp(e){
    if(!active || e.pointerId !== id) return;
    e.preventDefault();
    active = false;
    try { containerEl.releasePointerCapture && containerEl.releasePointerCapture(e.pointerId); } catch(e){}
    id = null;
    reset();
  }

  containerEl.addEventListener('pointerdown', onDown);
  window.addEventListener('pointermove', onMove, {passive:false});
  window.addEventListener('pointerup', onUp);
  window.addEventListener('pointercancel', onUp);
  window.addEventListener('resize', ()=> { maxRadius = Math.min(containerEl.clientWidth, containerEl.clientHeight)/2; });

  return { reset };
}

/* Left mapping -> WASD (ny negative = up) */
const leftJoy = document.getElementById('left-joy');
const leftStick = document.getElementById('left-stick');
function leftMapping(nx, ny){
  const thresh = 0.28;
  const keys = [];
  if(Math.abs(nx) < thresh && Math.abs(ny) < thresh) return keys;
  if(ny < -thresh) keys.push(KEY.W);
  if(ny > thresh) keys.push(KEY.S);
  if(nx < -thresh) keys.push(KEY.A);
  if(nx > thresh) keys.push(KEY.D);
  return keys;
}

/* Right mapping -> Arrow keys */
const rightJoy = document.getElementById('right-joy');
const rightStick = document.getElementById('right-stick');
function rightMapping(nx, ny){
  const thresh = 0.28;
  const keys = [];
  if(Math.abs(nx) < thresh && Math.abs(ny) < thresh) return keys;
  if(ny < -thresh) keys.push(KEY.UP);
  if(ny > thresh) keys.push(KEY.DOWN);
  if(nx < -thresh) keys.push(KEY.LEFT);
  if(nx > thresh) keys.push(KEY.RIGHT);
  return keys;
}

const leftJs = createJoystick(leftJoy, leftStick, leftMapping);
const rightJs = createJoystick(rightJoy, rightStick, rightMapping);

/* ---------------- Buttons (Q/E/Space) ---------------- */
function makeButton(el, keyObj){
  const pressCls = 'pressed';
  function down(e){
    e.preventDefault();
    el.classList.add(pressCls);
    dispatchKeyEvent('keydown', keyObj.key, keyObj.code, keyObj.keyCode);
  }
  function up(e){
    e.preventDefault();
    el.classList.remove(pressCls);
    dispatchKeyEvent('keyup', keyObj.key, keyObj.code, keyObj.keyCode);
  }
  el.addEventListener('pointerdown', down);
  window.addEventListener('pointerup', up);
  el.addEventListener('pointercancel', up);
  el.addEventListener('pointerout', up);
  el.addEventListener('lostpointercapture', up);

  el.setAttribute('tabindex','0');
  el.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' || e.key === ' ') down(e);
  });
  el.addEventListener('keyup', (e)=>{
    if(e.key === 'Enter' || e.key === ' ') up(e);
  });
}

makeButton(document.getElementById('btn-q'), KEY.Q);
makeButton(document.getElementById('btn-e'), KEY.E);
makeButton(document.getElementById('btn-space'), KEY.SPACE);

/* ---------------- Ensure keys are released on visibility change ---------------- */
document.addEventListener('visibilitychange', ()=>{
  if(document.hidden){
    const all = [KEY.W,KEY.A,KEY.S,KEY.D,KEY.UP,KEY.DOWN,KEY.LEFT,KEY.RIGHT,KEY.Q,KEY.E,KEY.SPACE];
    for(const k of all) dispatchKeyEvent('keyup', k.key, k.code, k.keyCode);
  }
});

/* ---------------- Fallback focus hint for user ---------------- */
(function focusOnTap(){
  const player = document.getElementById('ruffle');
  window.addEventListener('pointerdown', function once(){
    try { player.focus && player.focus(); } catch(e){}
    window.removeEventListener('pointerdown', once);
  }, {passive:true});
})();

/* ---------------- Console info ---------------- */
console.log("Pocket Isaac controls ready: left joystick=WASD, right joystick=arrows, Q/E/SPACE buttons.");
</script>
</body>
</html>
